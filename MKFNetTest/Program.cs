using Newtonsoft.Json.Linq;
using Newtonsoft.Json;

var mkf = new MKFNet();
var materialData = JObject.Parse(mkf.GetMaterial("3C97"));
// Console.WriteLine(materialData);


String masString = @"{""inputs"": {""designRequirements"": {""insulation"": {""altitude"": {""maximum"": 1000 }, ""cti"": ""Group IIIB"", ""pollutionDegree"": ""P2"", ""overvoltageCategory"": ""OVC-II"", ""insulationType"": ""Basic"", ""mainSupplyVoltage"": {""nominal"": null, ""minimum"": 100, ""maximum"": 815 }, ""standards"": [""IEC 60664-1""] }, ""leakageInductance"": [{""maximum"": 0.0000027 }, {""maximum"": 7.2e-7 } ], ""magnetizingInductance"": {""maximum"": null, ""minimum"": null, ""nominal"": 0.0007 }, ""market"": ""Commercial"", ""maximumDimensions"": {""width"": null, ""height"": 0.02, ""depth"": null }, ""maximumWeight"": null, ""name"": ""My Design Requirements"", ""operatingTemperature"": null, ""strayCapacitance"": [{""maximum"": 5e-11 }, {""maximum"": 5e-11 } ], ""terminalType"": [""Pin"", ""Pin"", ""Pin""], ""topology"": ""Flyback Converter"", ""turnsRatios"": [{""nominal"": 3.6 }, {""nominal"": 7 } ] }, ""operatingPoints"": [{""name"": ""Operating Point No. 1"", ""conditions"": {""ambientTemperature"": 42 }, ""excitationsPerWinding"": [{""name"": ""Primary winding excitation"", ""frequency"": 42000, ""current"": {""waveform"": {""ancillaryLabel"": null, ""data"": [0, 0, 1.1, 0, 0 ], ""numberPeriods"": null, ""time"": [0, 0, 0.000007, 0.000007, 0.00002380952380952381 ] }, ""processed"": {""dutyCycle"": 0.294, ""peakToPeak"": 1.1, ""offset"": 0, ""label"": ""Flyback Primary"", ""acEffectiveFrequency"": 320324.70197566116, ""effectiveFrequency"": 299906.6380380921, ""peak"": 1.0815263605442182, ""rms"": 0.34251379452955516, ""thd"": 1.070755363168311 }, ""harmonics"": {""amplitudes"": [0.16053906914328236, 0.29202196202762337, 0.21752279286410783, 0.1310845319633303, 0.07713860380309742, 0.06991594662329052, 0.06385479128189217, 0.04886550825820873, 0.041656942163512685, 0.04106933856014564, 0.036071164493133245, 0.03055299653431604, 0.02975135660550652, 0.028391215457215468, 0.02482068925428346, 0.023301839916889198, 0.023120564125526488, 0.021217296242203084, 0.019422484452150467, 0.019302597014669035, 0.018564086064230358, 0.016990298638197066, 0.016530128240448857, 0.016408746965119517, 0.015342013775419296, 0.014571250724490458, 0.014600261585603161, 0.014080719038131833, 0.013228104677648548, 0.013112646237623088, 0.012998033401152062, 0.012300975273665412, 0.011953654437324483, 0.012016309039770377, 0.011608286047010533, 0.011111174591424324, 0.011137874398755002, 0.01101797292674616, 0.010530630511366074, 0.01040049906973778, 0.01046208177619542, 0.010124703775041825, 0.009838808475080322, 0.009931053977331523, 0.0098034018119726, 0.009456464631666566, 0.009454698580407995, 0.009502890216301076, 0.009218272478811467, 0.00907613407579727, 0.009199516076645192, 0.00906471876755199, 0.008824889331959554, 0.008907818118804589, 0.008937898630441313, 0.00869876368067147, 0.008666288051213203, 0.008803433740422266, 0.008663604885115571, 0.008515486625290338, 0.008660125560530002, 0.008670306514975606, 0.008475927879718145, 0.008536460912837853 ], ""frequencies"": [0, 42000, 84000, 126000, 168000, 210000, 252000, 294000, 336000, 378000, 420000, 462000, 504000, 546000, 588000, 630000, 672000, 714000, 756000, 798000, 840000, 882000, 924000, 966000, 1008000, 1050000, 1092000, 1134000, 1176000, 1218000, 1260000, 1302000, 1344000, 1386000, 1428000, 1470000, 1512000, 1554000, 1596000, 1638000, 1680000, 1722000, 1764000, 1806000, 1848000, 1890000, 1932000, 1974000, 2016000, 2058000, 2100000, 2142000, 2184000, 2226000, 2268000, 2310000, 2352000, 2394000, 2436000, 2478000, 2520000, 2562000, 2604000, 2646000 ] } }, ""voltage"": {""waveform"": {""ancillaryLabel"": null, ""data"": [-29.4, 70.6, 70.6, -29.4, -29.4 ], ""numberPeriods"": null, ""time"": [0, 0, 0.000007, 0.000007, 0.00002380952380952381 ] }, ""processed"": {""dutyCycle"": 0.294, ""peakToPeak"": 100, ""offset"": 0, ""label"": ""Rectangular"", ""acEffectiveFrequency"": 273993.1760953399, ""effectiveFrequency"": 273985.04815560044, ""peak"": 70.6, ""rms"": 45.33538904652732, ""thd"": 0.7943280084778311 }, ""harmonics"": {""amplitudes"": [0.4937500000000009, 50.19273146886441, 30.88945734421223, 8.60726309175931, 7.514577540357868, 12.576487416046705, 7.890222788854489, 0.6723406687769768, 6.659332230305735, 6.771471403422372, 2.1663923211140617, 3.134209960512532, 5.356728264586365, 3.4347141143172375, 0.6805380572551197, 3.777520625726094, 3.7722086912079633, 1.0283716619016732, 2.1769829843489013, 3.474177141872247, 2.1027712520453545, 0.6945565902694819, 2.7474727308098412, 2.608727438661375, 0.5486770349329464, 1.7724349572072589, 2.6198081625264167, 1.4623766283543616, 0.71496628279737, 2.2318766983434566, 1.995656440067472, 0.2773827898281461, 1.562500000000001, 2.1411881515502134, 1.0841275629577949, 0.7426431917434089, 1.9342807953981735, 1.620450382955772, 0.09545259242683589, 1.4471144811333827, 1.8430944173488684, 0.8315259963159228, 0.7788650462348548, 1.7521633971823452, 1.3695427043271637, 0.042929496561759636, 1.388303796831737, 1.6472150875774871, 0.6472086912079588, 0.8254655623504514, 1.6415464278026473, 1.1917877639027972, 0.16004318769545572, 1.3696996040394052, 1.5166136111631239, 0.5023333497836172, 0.8850851521101957, 1.581550490460967, 1.0607923422947243, 0.2691521002455623, 1.3846695378376832, 1.4323337135341552, 0.38011439553529425, 0.9615889729028446 ], ""frequencies"": [0, 42000, 84000, 126000, 168000, 210000, 252000, 294000, 336000, 378000, 420000, 462000, 504000, 546000, 588000, 630000, 672000, 714000, 756000, 798000, 840000, 882000, 924000, 966000, 1008000, 1050000, 1092000, 1134000, 1176000, 1218000, 1260000, 1302000, 1344000, 1386000, 1428000, 1470000, 1512000, 1554000, 1596000, 1638000, 1680000, 1722000, 1764000, 1806000, 1848000, 1890000, 1932000, 1974000, 2016000, 2058000, 2100000, 2142000, 2184000, 2226000, 2268000, 2310000, 2352000, 2394000, 2436000, 2478000, 2520000, 2562000, 2604000, 2646000 ] } } }, {""name"": ""Primary winding excitation"", ""frequency"": 42000, ""current"": {""waveform"": {""ancillaryLabel"": null, ""data"": [0, 0, 3.96, 0, 0 ], ""numberPeriods"": null, ""time"": [0, 0.000011904761904761905, 0.000011904761904761905, 0.00002380952380952381, 0.00002380952380952381 ] }, ""processed"": {""dutyCycle"": 0.5, ""peakToPeak"": 3.96, ""offset"": 0, ""label"": ""Flyback Secondary"", ""acEffectiveFrequency"": 273605.22552591236, ""effectiveFrequency"": 239619.35667760254, ""peak"": 3.9599999999999986, ""rms"": 1.635596311125932, ""thd"": 0.6765065136547783 }, ""harmonics"": {""amplitudes"": [1.0054687500000032, 1.5109819803933975, 0.6305067526445318, 0.43631079159665215, 0.3156335707813906, 0.25867345007829645, 0.2108457708927511, 0.1845098972167098, 0.15858039332900484, 0.14374429235357594, 0.12732519999086678, 0.11798991339580255, 0.1065764142034965, 0.10027664365108102, 0.09183268563443873, 0.08737513814977015, 0.08084358345172529, 0.0775829517661027, 0.07235909588115942, 0.06991721285428486, 0.06562943182065245, 0.06377074179801741, 0.060177659717708575, 0.05874824283059186, 0.05568602880656547, 0.054581360149729106, 0.051934759310085545, 0.0510815825974439, 0.0487670673260459, 0.048112679051860716, 0.04606818176826717, 0.04557382535330518, 0.043752232085917345, 0.04338887874386873, 0.04175376612752825, 0.04149933709574444, 0.04002209784539918, 0.03985958700992044, 0.038517442612831645, 0.03843361846308103, 0.03720821487910577, 0.037192705080064635, 0.03606910115775439, 0.036113735798427, 0.03507966215426201, 0.03517799562893598, 0.03422330356713118, 0.0343702622545533, 0.03348650869654576, 0.03367812888504953, 0.03285826032368028, 0.03309149205770409, 0.032329601799393176, 0.032602161771072315, 0.0318933023014623, 0.032203563952980456, 0.031543601457069734, 0.03189051394290526, 0.03127601564366044, 0.03165904576198601, 0.03108719333289207, 0.0315062863179612, 0.03097481051580278, 0.03143036691725387 ], ""frequencies"": [0, 42000, 84000, 126000, 168000, 210000, 252000, 294000, 336000, 378000, 420000, 462000, 504000, 546000, 588000, 630000, 672000, 714000, 756000, 798000, 840000, 882000, 924000, 966000, 1008000, 1050000, 1092000, 1134000, 1176000, 1218000, 1260000, 1302000, 1344000, 1386000, 1428000, 1470000, 1512000, 1554000, 1596000, 1638000, 1680000, 1722000, 1764000, 1806000, 1848000, 1890000, 1932000, 1974000, 2016000, 2058000, 2100000, 2142000, 2184000, 2226000, 2268000, 2310000, 2352000, 2394000, 2436000, 2478000, 2520000, 2562000, 2604000, 2646000 ] } }, ""voltage"": {""waveform"": {""ancillaryLabel"": null, ""data"": [-13.89, 13.89, 13.89, -13.89, -13.89 ], ""numberPeriods"": null, ""time"": [0, 0, 0.000011904761904761905, 0.000011904761904761905, 0.00002380952380952381 ] }, ""processed"": {""dutyCycle"": 0.5, ""peakToPeak"": 27.78, ""offset"": 0, ""label"": ""Rectangular"", ""acEffectiveFrequency"": 248423.92512497256, ""effectiveFrequency"": 248408.7565140517, ""peak"": 13.89, ""rms"": 13.890000000000022, ""thd"": 0.48331514845248535 }, ""harmonics"": {""amplitudes"": [0.21703125, 17.681745968226167, 0.4340625, 5.884441743008607, 0.4340625, 3.5192857754085134, 0.4340625, 2.50156382659689, 0.4340625, 1.932968090534883, 0.4340625, 1.56850033166751, 0.4340625, 1.313925940874188, 0.4340625, 1.1252647178556892, 0.4340625, 0.9792293094780014, 0.4340625, 0.8623340820515439, 0.4340625, 0.7662274695502621, 0.4340625, 0.6854595927802318, 0.4340625, 0.6163213952979067, 0.4340625, 0.5561996920846202, 0.4340625, 0.5031990666519233, 0.4340625, 0.45591010107099894, 0.4340625, 0.41326185461487136, 0.4340625, 0.3744248874701925, 0.4340625, 0.33874569976854113, 0.4340625, 0.30570130348173624, 0.4340625, 0.2748670467095772, 0.4340625, 0.24589336899764186, 0.4340625, 0.21848870156913297, 0.4340625, 0.1924066733732579, 0.4340625, 0.16743638267205946, 0.4340625, 0.1433948809785266, 0.4340625, 0.12012127132032469, 0.4340625, 0.09747199388796957, 0.4340625, 0.07531698847858959, 0.4340625, 0.05353650312310587, 0.4340625, 0.03201837355771753, 0.4340625, 0.0106556362841701 ], ""frequencies"": [0, 42000, 84000, 126000, 168000, 210000, 252000, 294000, 336000, 378000, 420000, 462000, 504000, 546000, 588000, 630000, 672000, 714000, 756000, 798000, 840000, 882000, 924000, 966000, 1008000, 1050000, 1092000, 1134000, 1176000, 1218000, 1260000, 1302000, 1344000, 1386000, 1428000, 1470000, 1512000, 1554000, 1596000, 1638000, 1680000, 1722000, 1764000, 1806000, 1848000, 1890000, 1932000, 1974000, 2016000, 2058000, 2100000, 2142000, 2184000, 2226000, 2268000, 2310000, 2352000, 2394000, 2436000, 2478000, 2520000, 2562000, 2604000, 2646000 ] } } }, {""name"": ""Primary winding excitation"", ""frequency"": 42000, ""current"": {""waveform"": {""ancillaryLabel"": null, ""data"": [0, 0, 0.08, 0, 0 ], ""numberPeriods"": null, ""time"": [0, 0.000011904761904761905, 0.000011904761904761905, 0.00002380952380952381, 0.00002380952380952381 ] }, ""processed"": {""dutyCycle"": 0.5, ""peakToPeak"": 0.08, ""offset"": 0, ""label"": ""Flyback Secondary"", ""acEffectiveFrequency"": 273605.2255259123, ""effectiveFrequency"": 239619.35667760245, ""peak"": 0.07999999999999997, ""rms"": 0.03304234971971578, ""thd"": 0.6765065136547783 }, ""harmonics"": {""amplitudes"": [0.020312500000000067, 0.030524888492795912, 0.012737510154434986, 0.008814359426194993, 0.006376435773361427, 0.00522572626420801, 0.004259510523085881, 0.0037274726710446416, 0.0032036443096768643, 0.0029039250980520386, 0.0025722262624417523, 0.002383634614056616, 0.002153058872797908, 0.0020257907808299194, 0.0018552057703927027, 0.0017651543060559615, 0.0016332037060954627, 0.0015673323589111663, 0.0014617999167910994, 0.0014124689465512088, 0.001325847107487929, 0.0012882978141013626, 0.0012157102973274464, 0.001186833188496806, 0.001124970278920515, 0.0011026537403985668, 0.0010491870567694052, 0.0010319511635847236, 0.0009851932793140594, 0.000971973314179004, 0.0009306703387528712, 0.0009206833404708095, 0.0008838834764831795, 0.0008765430049266404, 0.0008435104268187535, 0.0008383704463786768, 0.000808527229199984, 0.0008052441820185946, 0.0007781301537945788, 0.0007764367366278998, 0.0007516811086688038, 0.0007513677793952459, 0.0007286687102576646, 0.0007295704201702419, 0.0007086800435204446, 0.0007106665783623426, 0.000691379870043054, 0.0006943487324152177, 0.0006764951251827419, 0.00068036624010201, 0.0006638032388622281, 0.0006685149910647295, 0.000653123268674609, 0.0006586295307287333, 0.0006443091374032789, 0.0006505770495551611, 0.0006372444738801973, 0.0006442528069273796, 0.0006318386998719282, 0.0006395766820603246, 0.0006280241077351936, 0.0006364906326860852, 0.0006257537477939952, 0.0006349569074192705 ], ""frequencies"": [0, 42000, 84000, 126000, 168000, 210000, 252000, 294000, 336000, 378000, 420000, 462000, 504000, 546000, 588000, 630000, 672000, 714000, 756000, 798000, 840000, 882000, 924000, 966000, 1008000, 1050000, 1092000, 1134000, 1176000, 1218000, 1260000, 1302000, 1344000, 1386000, 1428000, 1470000, 1512000, 1554000, 1596000, 1638000, 1680000, 1722000, 1764000, 1806000, 1848000, 1890000, 1932000, 1974000, 2016000, 2058000, 2100000, 2142000, 2184000, 2226000, 2268000, 2310000, 2352000, 2394000, 2436000, 2478000, 2520000, 2562000, 2604000, 2646000 ] } }, ""voltage"": {""waveform"": {""ancillaryLabel"": null, ""data"": [-7.14, 7.14, 7.14, -7.14, -7.14 ], ""numberPeriods"": null, ""time"": [0, 0, 0.000011904761904761905, 0.000011904761904761905, 0.00002380952380952381 ] }, ""processed"": {""dutyCycle"": 0.5, ""peakToPeak"": 14.28, ""offset"": 0, ""label"": ""Rectangular"", ""acEffectiveFrequency"": 248423.9251249721, ""effectiveFrequency"": 248408.75651405123, ""peak"": 7.14, ""rms"": 7.139999999999993, ""thd"": 0.4833151484524845 }, ""harmonics"": {""amplitudes"": [0.1115625, 9.08910483895859, 0.223125, 3.0248318246998886, 0.223125, 1.8090497074454124, 0.223125, 1.2859010598921377, 0.223125, 0.9936207463224668, 0.223125, 0.8062701488917218, 0.223125, 0.6754090149634054, 0.223125, 0.5784298117703113, 0.223125, 0.5033619344616945, 0.223125, 0.44327324304161464, 0.223125, 0.3938707078897675, 0.223125, 0.3523528792261233, 0.223125, 0.3168131578421202, 0.223125, 0.285908265045658, 0.223125, 0.2586638830737746, 0.223125, 0.23435551631727392, 0.223125, 0.21243265960764457, 0.223125, 0.19246894863478564, 0.223125, 0.1741284590602866, 0.223125, 0.1571423547055144, 0.223125, 0.14129234798462062, 0.223125, 0.1263987512342087, 0.223125, 0.1123116867677183, 0.223125, 0.09890451028690123, 0.223125, 0.08606881009924447, 0.223125, 0.07371054356995504, 0.223125, 0.0617470034000806, 0.223125, 0.05010439426638574, 0.223125, 0.0387158601682599, 0.223125, 0.027519843938011213, 0.223125, 0.016458688783449027, 0.223125, 0.005477411308063118 ], ""frequencies"": [0, 42000, 84000, 126000, 168000, 210000, 252000, 294000, 336000, 378000, 420000, 462000, 504000, 546000, 588000, 630000, 672000, 714000, 756000, 798000, 840000, 882000, 924000, 966000, 1008000, 1050000, 1092000, 1134000, 1176000, 1218000, 1260000, 1302000, 1344000, 1386000, 1428000, 1470000, 1512000, 1554000, 1596000, 1638000, 1680000, 1722000, 1764000, 1806000, 1848000, 1890000, 1932000, 1974000, 2016000, 2058000, 2100000, 2142000, 2184000, 2226000, 2268000, 2310000, 2352000, 2394000, 2436000, 2478000, 2520000, 2562000, 2604000, 2646000 ] } } } ] } ] }, ""magnetic"": {""coil"": {""functionalDescription"": [{""name"": ""Primary""}, {""name"": ""Secondary""}, {""name"": ""Tertiary""} ] } } }";
String weightsString = @"{""AREA_PRODUCT"":1,""ENERGY_STORED"":1,""COST"":1,""EFFICIENCY"":0,""DIMENSIONS"":1}";
var masJson = JObject.Parse(masString);
var inputsJson = masJson["inputs"];
var inputsString = JsonConvert.SerializeObject(inputsJson);
// Console.WriteLine(inputsString);

// var coreAdviserResultString = mkf.CalculateAdvisedCores(inputsString, weightsString, 2, true);
// var coreAdviserResult = JArray.Parse(coreAdviserResultString);
// Console.WriteLine(coreAdviserResult.Count());

var defaultModels = mkf.GetDefaultModels();

var magneticAdviserResultString = mkf.CalculateAdvisedMagnetics(inputsString, 1);
var magneticAdviserResult = JArray.Parse(magneticAdviserResultString);
// Console.WriteLine(magneticAdviserResult.Count());


var advisedMagneticString = JsonConvert.SerializeObject(magneticAdviserResult[0]["magnetic"]);
var advisedMagneticCoilString = JsonConvert.SerializeObject(magneticAdviserResult[0]["magnetic"]["coil"]);
var masInputsString = JsonConvert.SerializeObject(magneticAdviserResult[0]["inputs"]);
var operatingPointString = JsonConvert.SerializeObject(magneticAdviserResult[0]["inputs"]["operatingPoints"][0]);


var WoundCoilString = mkf.Wind(advisedMagneticCoilString);
var WoundCoil = JObject.Parse(WoundCoilString);

// Console.WriteLine(magneticAdviserResult[0]["magnetic"]["coil"]);
magneticAdviserResult[0]["magnetic"]["coil"] = WoundCoil;


// Console.WriteLine(WoundCoilString);
String coreOutFile = "./MKFNetTestCoreBefore.svg";
mkf.PlotSections(advisedMagneticString, coreOutFile);
Console.WriteLine(mkf.PlotTurns(advisedMagneticString, coreOutFile));


var advisedMagneticStringAfter = JsonConvert.SerializeObject(magneticAdviserResult[0]["magnetic"]);

coreOutFile = "./MKFNetTestCoreAfter.svg";
Console.WriteLine(mkf.PlotTurns(advisedMagneticStringAfter, coreOutFile));


// var windingLosses = mkf.CalculateWindingLosses(advisedMagneticString, operatingPointString, 69);
// Console.WriteLine(windingLosses);

// var coreLosses = mkf.CalculateCoreLosses(advisedMagneticString, masInputsString, defaultModels);
// Console.WriteLine(coreLosses);

// String fieldOutFile = "./MKFNetTestCoreAndField.svg";
// var plotResult = mkf.PlotField(advisedMagneticString, operatingPointString, fieldOutFile);
// String coreOutFile = "./MKFNetTestCore.svg";
// plotResult &= mkf.PlotCore(advisedMagneticString, coreOutFile);
// Console.WriteLine(plotResult);

// var settingsString = mkf.GetSettings();
// var settingsJson = JObject.Parse(settingsString);
// Console.WriteLine(settingsJson);
